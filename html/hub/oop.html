<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Object Oriented Programming</title>
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* General Reset & Body */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      font-family: 'Segoe UI', sans-serif;
      height: 100%;
      background: #f3f4f6;
      color: #333;
      overflow: hidden; /* Prevent bouncing and scrolling on body */
    }

    /* --- Loading Overlay --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 15px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    #loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    #loading-status {
      font-size: 1rem;
      color: #555;
    }
    #progress-bar {
      width: 80%;
      max-width: 400px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    #progress-bar-inner {
      width: 0%;
      height: 100%;
      background: #0078d4;
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    /* --- Loading Overlay Text Animation --- */
    #loading-advice {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #666;
      height: 20px; /* Reserve space to prevent layout shift */
      text-align: center;
      width: 100%;
      position: relative;
    }
    #loading-advice span {
      position: absolute;
      width: 100%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }
    #loading-advice span.visible {
      opacity: 1;
    }


    /* --- Sidebar & Overlay --- */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100%;
      background: #fff;
      z-index: 1001;
      box-shadow: 4px 0 15px rgba(0,0,0,0.1);
      transition: left 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
    }
    .sidebar.show {
      left: 0;
    }
    .sidebar h2 {
      font-size: 1.2rem;
      padding: 18px 20px;
      border-bottom: 1px solid #eee;
      color: #0078d4;
      flex-shrink: 0;
    }
    #pdf-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
    }
    #pdf-list li {
      padding: 0;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
      font-size: 0.9rem;
    }
    #pdf-list li:hover:not(.download-button-wrapper), 
    #pdf-list li.active {
      background-color: #eaf5ff;
      color: #005a9e;
      font-weight: 600;
    }
    #pdf-list li.external-link a {
        text-decoration: none;
        color: #3367d6;
        display: block;
        padding: 15px 20px;
    }
    #pdf-list li.external-link:hover {
        background-color: #f1f1f1;
    }
    #pdf-list li:not(.external-link):not(.download-button-wrapper) {
      padding: 15px 20px;
    }

    /* --- Download Button Styles --- */
    li.download-button-wrapper {
        padding: 15px 20px;
        background-color: #f7f7f7;
    }
    .download-button {
    --progress-percent: 0%; 
    position: relative;
    display: block;
    text-align: center;
    text-decoration: none;
    padding: 12px 20px;
    font-weight: bold;
    border-radius: 50px;
    color: white;
    background-color: #2196F3; /* Sky blue */
    background-image: linear-gradient(to right, #64B5F6, #2196F3 var(--progress-percent), #1E88E5 var(--progress-percent));
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); /* Softer blue shadow */
    transition: transform 0.2s ease-out, box-shadow 0.3s ease-out, background-color 0.3s;
    overflow: hidden;
}

.download-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 20px rgba(33, 150, 243, 0.4);
    background-color: #1976D2; /* Darker blue on hover */
}

.download-button:active {
    transform: translateY(0);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.5);
    background-color: #1565C0; /* Even darker blue on click */
}

    .download-button .button-text {
      position: relative;
      z-index: 2;
    }
    .download-button .button-icon {
      margin-right: 8px;
    }

    /* State: Downloading */
    .download-button.downloading {
        pointer-events: none; /* Prevent clicking while downloading */
        background-color: #6c757d; /* Grey background for progress */
    }
    .download-button.downloading .button-icon {
        animation: spin 1.5s linear infinite;
    }

    /* State: Completed */
    .download-button.completed {
        background-color: #007bff; /* Blue for completed */
        background-image: none; /* Remove progress gradient */
    }

    /* State: Failed */
    .download-button.failed {
        background-color: #dc3545; /* Red for failed */
        background-image: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }


    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* --- Main Layout --- */
    .main-content {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* --- Toolbar --- */
    .toolbar {
      background: #ffffff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      flex-shrink: 0;
      z-index: 999;
    }
    .toolbar .left, .toolbar .right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .toolbar .center {
      flex-grow: 1;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      padding: 0 10px;
    }
    .toolbar h1 {
      font-size: 18px;
      font-weight: 600;
      color: #0078d4;
    }
    .toolbar button {
      background-color: transparent;
      color: #333;
      border: none;
      padding: 8px;
      font-size: 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      line-height: 1;
    }
    .toolbar button:hover {
      background-color: #f0f0f0;
    }

    /* --- PDF Viewer Area --- */
    .pdf-viewer {
      flex-grow: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
      touch-action: pan-y;
    }
    .placeholder {
      color: #999;
      font-size: 16px;
      padding: 40px;
      text-align: center;
      margin: auto;
    }
    .pdf-page {
      margin-bottom: 25px;
      background: #fff;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .pdf-page canvas {
      display: block;
    }
    .loading-placeholder {
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #aaa;
      font-size: 18px;
    }

    /* --- Mobile & Responsive Adjustments --- */
    .mobile-only {
      display: none;
    }
    #pdf-select {
      max-width: 150px;
      padding: 8px 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
    }

    @media (max-width: 768px) {
      #burger-menu {
        display: none;
      }
      .mobile-only {
        display: block;
      }
      .toolbar .center h1 {
        font-size: 16px;
      }
      .pdf-viewer {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- Loading Overlay HTML -->
  <div id="loading-overlay">
    <div id="progress-bar">
      <div id="progress-bar-inner"></div>
    </div>
    <p id="loading-status">Loading...</p>
    <div id="loading-advice">
      <span>üê¢ Loading... slower than your professor‚Äôs lectures</span>
      <span>üß† Decoding ancient digital hieroglyphs...</span>
      <span>üìö Pretending to work hard...</span>
      <span>üîç Searching for logic in cloud...</span>
      <span>üíæ Asking the PDF politely to open</span>
      <span>üöÄ Still faster than waiting for semester results!</span>
      <span>‚è≥ 2 minutes feels like forever, doesn‚Äôt it?</span>
      <span>ü§ñ Converting binary into boredom...</span>
    </div>
  </div>

  <!-- Sidebar for PDF List (Desktop) -->
  <aside id="pdf-sidebar" class="sidebar">
    <h2>PDF & Sources</h2>
    <ul id="pdf-list"></ul>
  </aside>
  <div id="sidebar-overlay" class="overlay"></div>

  <!-- Main Content Wrapper -->
  <div class="main-content">
    <!-- Toolbar -->
    <header class="toolbar">
      <div class="left">
        <button id="burger-menu" title="Toggle PDF List">‚ò∞</button>
        <!-- Mobile Dropdown -->
        <select id="pdf-select" class="mobile-only"></select>
      </div>
      <div class="center">
        <h1 id="pdf-title">Object Oriented Programming</h1>
      </div>
      <div class="right">
        <button id="fullscreen" title="Full Screen"><i class="fa-solid fa-maximize"></i></button>
      </div>
    </header>

    <!-- PDF Viewer -->
    <main id="pdf-viewer" class="pdf-viewer">
      <p class="placeholder">Select a PDF from the menu to begin.</p>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

    const viewer = document.getElementById("pdf-viewer");
    const sidebar = document.getElementById("pdf-sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    const burgerMenu = document.getElementById("burger-menu");
    const pdfList = document.getElementById("pdf-list");
    const pdfSelect = document.getElementById("pdf-select");
    const pdfTitle = document.getElementById("pdf-title");
    const fullscreenBtn = document.getElementById("fullscreen");
    const loadingOverlay = document.getElementById("loading-overlay");
    const loadingStatus = document.getElementById("loading-status");
    const progressBarInner = document.getElementById("progress-bar-inner");
    const loadingAdvice = document.getElementById("loading-advice");

    let pdfDoc = null;
    let scale = 1.5;
    const pageStates = {};
    let currentPdfUrl = null;
    let loadingStartTime = null;
    let loadingTimerInterval = null;
    let adviceTimerInterval = null;
    let adviceSpans = [];
    let currentAdviceIndex = 0;

    const PDF_FILES = [
      {
        name: "OOP Note 1 by Riaz (‡¶è‡¶á ‡¶®‡ßã‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶á‡¶ú ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡ßß‡ß¶‡ß¶ ‡¶è‡¶Æ‡¶¨‡¶ø ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶Æ‡¶ø‡¶° ‡¶Ü‡¶∞ ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶§‡¶æ‡¶á ‡¶®‡ßã‡¶ü ‡¶≤‡ßã‡¶° ‡¶π‡¶§‡ßá ‡¶Ö‡¶®‡ßá‡¶ï ‡¶∏‡¶Æ‡ßü ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡•§  ‡¶§‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∞‡¶æ‡¶ñ‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶®‡¶æ ‡¶≤‡¶æ‡¶ó‡ßá‡•§)",
        url: "https://corsproxy.io/?https://drive.google.com/uc?export=download&id=1DoAEpbKO07WK_TEFcNanO_YXjyxcPd-A",
      },
      {
        name: "Download the Note",
        url: "https://drive.google.com/uc?export=download&id=1DoAEpbKO07WK_TEFcNanO_YXjyxcPd-A",
        // The CORS proxy URL is needed for the fetch API to work
        corsUrl: "https://corsproxy.io/?https://drive.google.com/uc?export=download&id=1DoAEpbKO07WK_TEFcNanO_YXjyxcPd-A",
        type: 'download'
      },
      {
        name: 'Learnix Resources <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i>',
        url: 'https://drive.google.com/drive/folders/1YyQFiUGhanhtOW2nXp2irQ8redPmyYY7?usp=drive_link',
        type: 'link'
      },
      {
        name: 'Previous Questions & Solution by Nurul Alam Ador <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i>',
        url: 'https://nurulalamador.github.io/UIUQuestionBank/course.html?id=CSE1115',
        type: 'link'
      }
    ];

    window.addEventListener("DOMContentLoaded", () => {
      populatePdfList();
      populatePdfDropdown();
      setupEventListeners();
      adviceSpans = loadingAdvice.querySelectorAll('span');
    });

    function populatePdfList() {
      pdfList.innerHTML = "";
      PDF_FILES.forEach(item => {
        const li = document.createElement("li");
        
        if (item.type === 'link') {
          li.classList.add('external-link');
          const a = document.createElement('a');
          a.href = item.url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.innerHTML = item.name;
          li.appendChild(a);
        } else if (item.type === 'download') {
          li.classList.add('download-button-wrapper');
          const a = document.createElement('a');
          a.href = item.url;
          a.dataset.corsUrl = item.corsUrl; // Store the CORS URL
          a.className = 'download-button';
          // We no longer need the 'download' attribute here as JS will handle it
          a.innerHTML = `<i class="fa-solid fa-download button-icon"></i> <span class="button-text">${item.name}</span>`;
          li.appendChild(a);
        } else {
          li.innerHTML = item.name;
          li.dataset.url = item.url;
        }
        pdfList.appendChild(li);
      });
    }

    function populatePdfDropdown() {
      pdfSelect.innerHTML = '<option value="" disabled selected>Select an item...</option>';
      PDF_FILES.forEach(item => {
        const option = document.createElement("option");
        option.value = item.url;
        const cleanName = item.name.replace(/<[^>]*>?/gm, '');
        
        if (item.type === 'link') {
            option.innerHTML = `‚Üí ${cleanName}`;
            option.dataset.isLink = 'true';
        } else if (item.type === 'download') {
            option.innerHTML = `‚Üì ${cleanName}`;
            option.dataset.isDownload = 'true';
        } else {
            option.textContent = cleanName;
        }
        pdfSelect.appendChild(option);
      });
    }

    function setupEventListeners() {
      burgerMenu.addEventListener("click", toggleSidebar);
      overlay.addEventListener("click", toggleSidebar);

      pdfList.addEventListener("click", (e) => {
        const downloadButton = e.target.closest('.download-button');
        const pdfItem = e.target.closest('li:not(.external-link):not(.download-button-wrapper)');

        if (downloadButton) {
            e.preventDefault(); // IMPORTANT: Prevent default link navigation
            startAdvancedDownload(downloadButton);
        } else if (pdfItem) {
            const url = pdfItem.dataset.url;
            if (url && url !== currentPdfUrl) {
                loadPDF(url);
                toggleSidebar();
            }
        }
      });

      pdfSelect.addEventListener("change", (e) => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const url = e.target.value;

        if (selectedOption.dataset.isLink === 'true') {
            window.open(url, '_blank', 'noopener,noreferrer');
            e.target.value = currentPdfUrl || '';
        } else if (selectedOption.dataset.isDownload === 'true') {
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'note.pdf');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            e.target.value = currentPdfUrl || '';
        } else if (url && url !== currentPdfUrl) {
            loadPDF(url);
        }
      });
      
      // Other listeners...
      fullscreenBtn.addEventListener("click", () => { /* ... */ });
      viewer.addEventListener("touchstart", (e) => { /* ... */ });
      viewer.addEventListener("touchmove", (e) => { /* ... */ }, { passive: false });
      viewer.addEventListener("touchend", () => { /* ... */ });
    }

    // --- NEW: ADVANCED DOWNLOAD FUNCTION ---
    async function startAdvancedDownload(button) {
        const url = button.dataset.corsUrl;
        const originalText = button.querySelector('.button-text').textContent;
        const buttonText = button.querySelector('.button-text');
        const buttonIcon = button.querySelector('.button-icon');

        button.classList.add('downloading');
        buttonIcon.className = 'fa-solid fa-spinner button-icon';
        buttonText.textContent = 'Starting...';

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const totalSize = Number(response.headers.get('content-length'));
            if (!totalSize) {
                console.warn("Content-Length header not found. Cannot show progress.");
                // Fallback to simple download if progress isn't possible
                const blob = await response.blob();
                triggerSave(blob, 'downloaded-note.pdf');
                setButtonState(button, 'completed', originalText);
                return;
            }

            let receivedSize = 0;
            const chunks = [];
            const reader = response.body.getReader();

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;

                chunks.push(value);
                receivedSize += value.length;
                const percentage = Math.round((receivedSize / totalSize) * 100);
                
                button.style.setProperty('--progress-percent', `${percentage}%`);
                buttonText.textContent = `Downloading... ${percentage}%`;
            }

            const blob = new Blob(chunks);
            triggerSave(blob, 'OOP-Note-by-Riaz.pdf'); // Provide a descriptive filename
            setButtonState(button, 'completed', originalText);

        } catch (error) {
            console.error('Download failed:', error);
            setButtonState(button, 'failed', originalText);
        }
    }

    function triggerSave(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    }

    function setButtonState(button, state, originalText) {
        const buttonText = button.querySelector('.button-text');
        const buttonIcon = button.querySelector('.button-icon');
        button.classList.remove('downloading');
        button.classList.add(state);

        if (state === 'completed') {
            buttonIcon.className = 'fa-solid fa-check button-icon';
            buttonText.textContent = 'Completed!';
        } else if (state === 'failed') {
            buttonIcon.className = 'fa-solid fa-xmark button-icon';
            buttonText.textContent = 'Download Failed';
        }

        setTimeout(() => {
            button.classList.remove(state);
            buttonIcon.className = 'fa-solid fa-download button-icon';
            buttonText.textContent = originalText;
            button.style.setProperty('--progress-percent', '0%');
        }, 4000); // Reset button after 4 seconds
    }
    
    // --- All other functions (loadPDF, renderPage, etc.) remain the same ---
    
    // ... [ The rest of your JavaScript code from the previous version ] ...
    // --- Loading Animation Functions ---
    function startLoadingAnimation() { /* ... unchanged ... */ }
    function finishLoadingAnimation() { /* ... unchanged ... */ }
    function hideLoadingAnimationOnError() { /* ... unchanged ... */ }
    // --- UI & STATE HELPERS ---
    function toggleSidebar() { /* ... unchanged ... */ }
    function updateActivePdfUI(url) { /* ... unchanged ... */ }
    // --- PDF RENDERING CORE ---
    function loadPDF(url) { /* ... unchanged ... */ }
    function renderPlaceholders() { /* ... unchanged ... */ }
    function renderPage(pageNum, isFinalStep = false) { /* ... unchanged ... */ }
    function observePages() { /* ... unchanged ... */ }
    function updateScale(newScale) { /* ... unchanged ... */ }
    // --- UTILITIES ---
    function getDistance(t1, t2) { /* ... unchanged ... */ }

    // --- PASTE UNCHANGED FUNCTIONS HERE ---
    function startLoadingAnimation() {
      loadingOverlay.classList.add('show');
      progressBarInner.style.width = '0%';
      loadingStartTime = performance.now();
      
      loadingTimerInterval = setInterval(() => {
        const elapsedTime = ((performance.now() - loadingStartTime) / 1000).toFixed(1);
        loadingStatus.textContent = `Fetching PDF... (${elapsedTime}s)`;
      }, 100);

      if (adviceTimerInterval) clearInterval(adviceTimerInterval);
      adviceSpans.forEach(span => span.classList.remove('visible'));
      currentAdviceIndex = 0;
      
      const showNextAdvice = () => {
        adviceSpans.forEach(span => span.classList.remove('visible'));
        if (adviceSpans[currentAdviceIndex]) {
          adviceSpans[currentAdviceIndex].classList.add('visible');
        }
        currentAdviceIndex = (currentAdviceIndex + 1) % adviceSpans.length;
      };

      setTimeout(() => {
        showNextAdvice();
        adviceTimerInterval = setInterval(showNextAdvice, 4000);
      }, 1500);
    }
    function finishLoadingAnimation() {
      clearInterval(loadingTimerInterval);
      clearInterval(adviceTimerInterval);
      progressBarInner.style.width = '100%';
      const duration = ((performance.now() - loadingStartTime) / 1000).toFixed(2);
      loadingStatus.textContent = `Loaded in ${duration} seconds!`;

      setTimeout(() => {
        loadingOverlay.classList.remove('show');
      }, 500);
    }
    function hideLoadingAnimationOnError() {
        clearInterval(loadingTimerInterval);
        clearInterval(adviceTimerInterval);
        loadingOverlay.classList.remove('show');
    }
    function toggleSidebar() {
      sidebar.classList.toggle("show");
      overlay.classList.toggle("show");
    }
    function updateActivePdfUI(url) {
      currentPdfUrl = url;
      const pdfItem = PDF_FILES.find(p => p.url === url && p.type !== 'link' && p.type !== 'download');
      pdfTitle.textContent = pdfItem ? pdfItem.name.replace(/<[^>]*>?/gm, '') : "Object Oriented Programming";
      document.querySelectorAll("#pdf-list li").forEach(li => {
        li.classList.toggle("active", li.dataset.url === url);
      });
      if (pdfSelect.value !== url) {
        pdfSelect.value = url;
      }
    }
    function loadPDF(url) {
      startLoadingAnimation();
      updateActivePdfUI(url);

      const loadingTask = pdfjsLib.getDocument(url);
      loadingTask.promise.then(pdf => {
        pdfDoc = pdf;
        viewer.innerHTML = "";
        
        clearInterval(loadingTimerInterval);
        const elapsedTime = ((performance.now() - loadingStartTime) / 1000).toFixed(1);
        loadingStatus.textContent = `Rendering... (${elapsedTime}s)`;
        progressBarInner.style.width = '30%';

        return pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale: 1 });
          const containerWidth = viewer.clientWidth;
          const padding = window.innerWidth <= 768 ? 20 : 40;
          const effectiveWidth = containerWidth - padding; 
          scale = effectiveWidth / viewport.width;
          
          renderPlaceholders();
          observePages();

          const renderTask = renderPage(1, true); 
          return renderTask; 
        });

      }).catch(error => {
        console.error("Error loading PDF from URL:", url, error);
        viewer.innerHTML = `<p class="placeholder">Error loading PDF. Please check the file link and its permissions (CORS policy).</p>`;
        hideLoadingAnimationOnError();
      });
    }
    function renderPlaceholders() {
      Object.keys(pageStates).forEach(key => delete pageStates[key]);
      viewer.innerHTML = '';
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const container = document.createElement("div");
        container.className = "pdf-page";
        container.id = `page-${i}`;
        container.dataset.pageNumber = i;
        const loadingText = document.createElement("div");
        loadingText.className = "loading-placeholder";
        loadingText.innerText = `Page ${i}`; 
        container.appendChild(loadingText);
        viewer.appendChild(container);
        pageStates[i] = false;
      }
    }
    function renderPage(pageNum, isFinalStep = false) {
      if (!pdfDoc || pageStates[pageNum]) return Promise.resolve();
      pageStates[pageNum] = true;

      return pdfDoc.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        const outputScale = window.devicePixelRatio || 1;
        canvas.width = Math.floor(viewport.width * outputScale);
        canvas.height = Math.floor(viewport.height * outputScale);
        canvas.style.width = `${Math.floor(viewport.width)}px`;
        canvas.style.height = `${Math.floor(viewport.height)}px`;
        const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;
        const renderContext = { canvasContext: context, viewport, transform };
        const pageContainer = document.getElementById(`page-${pageNum}`);
        if (pageContainer) {
            pageContainer.innerHTML = "";
            pageContainer.appendChild(canvas);
        }
        
        const renderTask = page.render(renderContext);
        if (isFinalStep) {
            renderTask.promise.then(() => {
                finishLoadingAnimation();
            });
        }
        return renderTask.promise;
      });
    }
    function observePages() {
      const options = { root: viewer, rootMargin: "200px", threshold: 0 };
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const pageNum = parseInt(entry.target.dataset.pageNumber);
            renderPage(pageNum);
          }
        });
      }, options);
      document.querySelectorAll(".pdf-page").forEach(page => observer.observe(page));
    }
    function updateScale(newScale) {
      if (!pdfDoc || Math.abs(scale - newScale) < 0.01) return;
      scale = newScale;
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const pageContainer = document.getElementById(`page-${i}`);
        if (!pageContainer) continue;
        const rect = pageContainer.getBoundingClientRect();
        const isVisible = rect.bottom >= 0 && rect.top <= window.innerHeight;
        if (isVisible) {
           pageStates[i] = false;
           renderPage(i);
        } else if (pageStates[i]) {
           pageContainer.innerHTML = `<div class="loading-placeholder">Page ${i}</div>`;
           pageStates[i] = false;
        }
      }
    }
    function getDistance(t1, t2) {
      const dx = t2.clientX - t1.clientX;
      const dy = t2.clientY - t1.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
  </script>
</body>
</html>